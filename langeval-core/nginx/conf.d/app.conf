server {
    listen 80 default_server;
    server_name api.langeval.space _ localhost;
    server_tokens off;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Root health check
    location = / {
        return 200 '{"status": "ok", "message": "Langeval API Gateway", "services": {"identity": "/identity/", "resource": "/resource/", "orchestrator": "/orchestrator/", "gen_ai": "/gen-ai/", "simulation": "/simulation/", "evaluation": "/evaluation/"}}';
        add_header Content-Type application/json;
    }

    # --- API v1 Unified Routing (Matches Local Dev) ---
    location /api/v1/auth/ {
        proxy_pass http://identity-service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/workspaces {
        proxy_pass http://identity-service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/invites {
        proxy_pass http://identity-service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/resource/ {
        proxy_pass http://resource-service:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/orchestrator/ {
        proxy_pass http://orchestrator:8000/orchestrator/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/gen-ai/ {
        proxy_pass http://gen-ai-service:8000/gen-ai/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/billing/ {
        proxy_pass http://billing-service:8000/api/v1/billing/;
        include /etc/nginx/conf.d/proxy_params;
    }

    # --- Legacy / Service Direct Paths ---
    location /identity/ {
        proxy_pass http://identity-service:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /resource/ {
        proxy_pass http://resource-service:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }

    # Orchestrator also uses /orchestrator prefix internally for some routes
    location /orchestrator/ {
        proxy_pass http://orchestrator:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /gen-ai/ {
        proxy_pass http://gen-ai-service:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }

    # --- Workers (Exposed for Swagger UI) ---
    location /simulation/ {
        proxy_pass http://simulation-worker:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /evaluation/ {
        proxy_pass http://evaluation-worker:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }
}

server {
    listen 443 ssl;
    server_name api.langeval.space;
    server_tokens off;

    ssl_certificate /etc/letsencrypt/live/api.langeval.space/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.langeval.space/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location = / {
        return 200 '{"status": "ok", "message": "Langeval API Gateway", "services": {"identity": "/identity/", "resource": "/resource/", "orchestrator": "/orchestrator/", "gen_ai": "/gen-ai/", "simulation": "/simulation/", "evaluation": "/evaluation/"}}';
        add_header Content-Type application/json;
    }

    # --- API v1 Unified Routing ---
    location /api/v1/auth/ {
        proxy_pass http://identity-service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/workspaces {
        proxy_pass http://identity-service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/invites {
        proxy_pass http://identity-service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/resource/ {
        proxy_pass http://resource-service:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/orchestrator/ {
        proxy_pass http://orchestrator:8000/orchestrator/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/gen-ai/ {
        proxy_pass http://gen-ai-service:8000/gen-ai/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/billing/ {
        proxy_pass http://billing-service:8000/api/v1/billing/;
        include /etc/nginx/conf.d/proxy_params;
    }

    # --- Legacy Paths ---
    location /identity/ {
        proxy_pass http://identity-service:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /resource/ {
        proxy_pass http://resource-service:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /orchestrator/ {
        proxy_pass http://orchestrator:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /gen-ai/ {
        proxy_pass http://gen-ai-service:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }

    # --- Workers ---
    location /simulation/ {
        proxy_pass http://simulation-worker:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /evaluation/ {
        proxy_pass http://evaluation-worker:8000/;
        include /etc/nginx/conf.d/proxy_params;
    }
}
